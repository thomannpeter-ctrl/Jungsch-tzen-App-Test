<!doctype html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Jungsch√ºtzen Amtscup</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="apple-touch-icon.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#1e3a8a">

<style>
*{box-sizing:border-box}
body{font-family:system-ui,sans-serif;background:#eef2f7;margin:0}
.container{max-width:1200px;margin:auto;padding:1rem}
h1{color:#1e3a8a}
h2{color:#1d4ed8}

.card{
 background:#fff;border-radius:14px;
 padding:1rem;margin-bottom:1rem;
 box-shadow:0 4px 10px rgba(0,0,0,.08)
}

input,select{
 width:100%;padding:.45rem;
 border-radius:8px;border:1px solid #cbd5f5
}

table{width:100%;border-collapse:collapse;font-size:.85rem}
th,td{border:1px solid #e5e7eb;padding:.35rem;text-align:center}
th{background:#dbeafe}

td.name input{width:100%}
td.year input{width:70px;text-align:center}
td.gender select{width:70px}
td.res input{width:60px;text-align:center}

button{
 border:none;border-radius:999px;
 padding:.9rem;font-size:1rem;
 background:#2563eb;color:white;
 width:100%;cursor:pointer
}

.winner-ok{background:#dcfce7;padding:.7rem;border-radius:12px;font-weight:700}
.winner-none{background:#e5e7eb;padding:.7rem;border-radius:12px}

.notice{
 background:#fff7ed;border:1px solid #fdba74;
 border-radius:12px;padding:.9rem;font-size:.9rem
}
</style>
</head>

<body>
<div class="container">

<h1>Jungsch√ºtzen Amtscup</h1>

<div class="card">
<h2>1. Gruppenchef</h2>
<label>Name *</label>
<input id="chef">
<label>E-Mail *</label>
<input id="email" type="email">
</div>

<div class="card">
<h2>2. Gruppenauswahl</h2>
<select id="g1"></select>
<select id="g2"></select>
<select id="g3"></select>
</div>

<div id="groups"></div>

<div class="card">
<h2>Sieger</h2>
<div id="winner" class="winner-none">‚Äì</div>
</div>

<div class="card notice">
üì∏ <b>Hinweis:</b> Standblatt-Foto bitte separat aufbewahren.
</div>

<div class="card">
<button onclick="sendToGoogle()">üì§ Resultate √ºbermitteln</button>
</div>

</div>

<script>
// ‚úÖ NEUE, KORREKTE SCRIPT-URL
const SCRIPT_URL ="https://script.google.com/macros/s/AKfycbx77euofJjO0W2AFV0btt-ZKz9YPTYzfW1eG6b1gO0kU4rKskrdTg9lo36pEUaaIZcT/exec";

const WETTKAMPF = "Jungsch√ºtzen Amtscup";
const state = {};

async function loadGroups(){
 const r = await fetch("gruppen.txt?v="+Date.now());
 const list = (await r.text()).split(/\r?\n/).filter(Boolean);

 ["g1","g2","g3"].forEach(id=>{
  const s=document.getElementById(id);
  s.innerHTML="<option value=''>Bitte w√§hlen‚Ä¶</option>";
  list.forEach(g=>s.add(new Option(g,g)));
  s.onchange=()=>selectGroup(id);
 });
}

function selectGroup(id){
 const name=document.getElementById(id).value;
 if(!name) return;
 if(!state[id]) state[id]={name,rows:[{},{},{},{}]};
 render();
}

function render(){
 groups.innerHTML="";
 Object.values(state).forEach((g,gi)=>{
  const c=document.createElement("div");
  c.className="card";
  c.innerHTML=`
   <h2>Gruppe ${gi+1}: ${g.name}</h2>
   <table>
    <tr><th>#</th><th>Name</th><th>Jahrgang</th><th>G</th><th>Resultat</th></tr>
   </table>`;
  const t=c.querySelector("table");

  g.rows.forEach((r,i)=>{
   const tr=t.insertRow();
   tr.innerHTML=`
    <td>${i+1}</td>
    <td class="name"><input value="${r.n||""}"></td>
    <td class="year"><input value="${r.y||""}"></td>
    <td class="gender">
     <select>
      <option value=""></option>
      <option value="m" ${r.g==="m"?"selected":""}>m</option>
      <option value="w" ${r.g==="w"?"selected":""}>w</option>
     </select>
    </td>
    <td class="res"><input type="number" value="${r.r||""}"></td>`;

   const inp=tr.querySelectorAll("input,select");
   inp[0].oninput=e=>r.n=e.target.value;
   inp[1].oninput=e=>r.y=e.target.value;
   inp[2].onchange=e=>r.g=e.target.value;
   inp[3].oninput=e=>{
    const v=Number(e.target.value);
    if(v>150){
     alert("‚ùå Maximal 150 Punkte erlaubt");
     e.target.value=r.r||"";
     return;
    }
    r.r=v;
    calcWinner();
   };
  });
  groups.appendChild(c);
 });
 calcWinner();
}

function calcWinner(){
 const arr=Object.values(state)
  .map(g=>({n:g.name,t:g.rows.reduce((a,b)=>a+(+b.r||0),0)}))
  .filter(x=>x.t>0);

 if(arr.length<2){
  winner.textContent="‚Äì";
  winner.className="winner-none";
  return;
 }

 arr.sort((a,b)=>b.t-a.t);
 winner.className="winner-ok";

 if(arr.length===2){
  winner.innerHTML=`üèÜ Sieger: ${arr[0].n} (${arr[0].t})<br>‚ùå Verlierer: ${arr[1].n} (${arr[1].t})`;
 }else{
  winner.innerHTML=`üèÜ Sieger: ${arr[0].n} & ${arr[1].n}<br>‚ùå Verlierer: ${arr[2].n}`;
 }
}

async function sendToGoogle(){
 if(!chef.value||!email.value){
  alert("Name und E-Mail sind Pflichtfelder");
  return;
 }

 const rows=[];
 const date=new Date().toISOString().slice(0,10);

 Object.values(state).forEach(g=>{
  g.rows.forEach((r,i)=>{
   if(r.n||r.r){
    rows.push({
     Datum:date,
     Wettkampf:WETTKAMPF,
     Gruppe:g.name,
     Nr:i+1,
     Name:r.n||"",
     Jahrgang:r.y||"",
     Gender:r.g||"",
     Resultat:r.r||"",
     Gruppenchef:chef.value,
     Email:email.value
    });
   }
  });
 });

 if(!rows.length){
  alert("Keine Resultate erfasst");
  return;
 }

 try{
  const res = await fetch(SCRIPT_URL,{
   method:"POST",
   headers:{ "Content-Type":"application/json" },
   body:JSON.stringify(rows)
  });

  if(!res.ok) throw new Error("HTTP Fehler");

  alert("‚úÖ Resultate erfolgreich √ºbermittelt");
  location.reload();

 }catch(err){
  alert("‚ùå √úbermittlung fehlgeschlagen");
  console.error(err);
 }
}

loadGroups();
</script>
</body>
</html>
